# Автоматическая работа с репозиториями

## Дата: 29 октября 2025

## Описание изменений

Реализована автоматизация работы с репозиториями проектов:
1. Автоматическая генерация путей к репозиториям
2. Добавлена отдельная папка `repos/` для всех репозиториев
3. Автоматическое переключение на ветки при выборе проекта

## Что изменилось

### 1. Отдельная папка для репозиториев

**До:**
- Репозитории клонировались куда угодно (пользователь вводил путь вручную)
- Риск клонирования в корень проекта или другие неподходящие места
- Пути репозиториев не игнорировались в git

**После:**
- Все репозитории автоматически клонируются в папку `repos/`
- Папка `repos/` добавлена в `.gitignore`
- Путь генерируется автоматически из названия проекта

### 2. Упрощён мастер создания проекта

**До:**
- 7 шагов при создании проекта
- Нужно было вручную вводить путь к репозиторию
- Шаг 5: "Локальный путь к репозиторию"

**После:**
- 6 шагов при создании проекта
- Путь генерируется автоматически
- Шаг 5 (локальный путь) удалён полностью

### 3. Автоматическая работа с ветками

**До:**
- После выбора проекта репозиторий только клонировался/обновлялся
- Не было автоматического переключения на нужную ветку
- Нужно было вручную переключаться на ветку разработки

**После:**
- При клонировании автоматически переключается на ветку разработки
- При обновлении выполняется:
  - `git fetch --all`
  - `git checkout <dev_branch>` - автоматически!
  - `git pull origin <dev_branch>` - автоматически!
  - `git submodule update --init --recursive` - автоматически!

## Изменённые файлы

### 1. `.gitignore`

Добавлено:
```gitignore
# Cloned project repositories
repos/
repositories/
```

### 2. `add_project_wizard.py`

**Изменения:**
- Добавлена константа `REPOS_DIR = os.path.join(os.getcwd(), "repos")`
- Добавлен импорт `re` для очистки имени проекта
- Удалено состояние `WAITING_LOCAL_PATH` (было 8 состояний, стало 7)
- Метод `receive_project_file_path` теперь автоматически генерирует путь:
  ```python
  clean_name = re.sub(r'[^\w\s-]', '', project_name).strip().replace(' ', '_').lower()
  local_repo_path = os.path.join(REPOS_DIR, clean_name)
  ```
- Удалён метод `receive_local_path`
- Обновлена нумерация шагов (было "из 7", стало "из 6")

### 3. `project_select_callback.py`

**Изменения:**
- При клонировании добавлено:
  ```python
  # After cloning, checkout dev branch
  result = subprocess.run(["git", "-C", repo_path, "checkout", project.dev_branch], ...)
  ```

- При обновлении существующего репозитория добавлено:
  ```python
  # Checkout dev branch
  subprocess.run(["git", "-C", repo_path, "checkout", project.dev_branch], ...)
  
  # Pull latest changes from dev branch
  subprocess.run(["git", "-C", repo_path, "pull", "origin", project.dev_branch], ...)
  
  # Update submodules
  subprocess.run(["git", "-C", repo_path, "submodule", "update", "--init", "--recursive"], ...)
  ```

## Пример работы

### Создание проекта

**Было (7 шагов):**
```
/add_project
Шаг 1/7: Название → MyApp
Шаг 2/7: Тип → flutter
Шаг 3/7: Git URL → https://github.com/user/myapp
Шаг 4/7: Файл проекта → pubspec.yaml
Шаг 5/7: Локальный путь → /home/user/repos/myapp  ← ВРУЧНУЮ!
Шаг 6/7: Ветка разработки → develop
Шаг 7/7: Ветка релиза → main
```

**Стало (6 шагов):**
```
/add_project
Шаг 1/6: Название → MyApp
Шаг 2/6: Тип → flutter
Шаг 3/6: Git URL → https://github.com/user/myapp
Шаг 4/6: Файл проекта → pubspec.yaml
             ↓ АВТОМАТИЧЕСКИ: repos/myapp
Шаг 5/6: Ветка разработки → develop
Шаг 6/6: Ветка релиза → main
```

### Выбор проекта

**Было:**
```
/build → выбор проекта
  ↓
Клонирование/обновление репозитория
  ↓
Репозиторий готов (но на какой ветке?)
  ↓
[Кнопка: Подготовить релиз]
```

**Стало:**
```
/build → выбор проекта
  ↓
Клонирование/обновление репозитория
  ↓ АВТОМАТИЧЕСКИ:
  ├─ git checkout develop
  ├─ git pull origin develop
  └─ git submodule update --init --recursive
  ↓
Репозиторий готов на ветке develop ✅
  ↓
[Кнопка: Подготовить релиз]
```

## Структура папок

После изменений:

```
easybuild_bot/
├── repos/                          # Новая папка (в .gitignore)
│   ├── myapp/                      # Автоматически создаётся
│   ├── coolproject/                # Имя из названия проекта
│   └── easybuild_bot/              # Очищенное имя (lowercase, без спецсимволов)
├── python/
├── dart/
├── docs/
└── .gitignore                       # repos/ добавлено
```

## Преимущества

✅ **Порядок в файлах** - все репозитории в одной папке `repos/`

✅ **Не засоряет git** - папка `repos/` в `.gitignore`

✅ **Автоматизация** - не нужно вручную вводить пути

✅ **Меньше шагов** - создание проекта проще (6 вместо 7)

✅ **Автоматическое переключение** - всегда на правильной ветке

✅ **Актуальный код** - автоматический pull при выборе проекта

✅ **Обновлённые подмодули** - автоматически обновляются

## Безопасность

- Пути валидируются и очищаются от спецсимволов
- Используется `os.path.join()` для правильных путей на любой ОС
- Все git операции с timeout'ами
- Ошибки обрабатываются корректно

## Миграция существующих проектов

Для существующих проектов с путями вне папки `repos/`:

### Вариант 1: Оставить как есть
- Существующие проекты продолжат работать со старыми путями
- Новые проекты будут создаваться в `repos/`

### Вариант 2: Переместить вручную
1. Остановить бота
2. Переместить репозитории в `repos/`:
   ```bash
   mkdir -p repos
   mv /old/path/myapp repos/myapp
   ```
3. Обновить пути в базе данных или пересоздать проекты

## Тестирование

Рекомендуется протестировать:

1. ✅ Создание нового проекта - проверить что путь в `repos/<имя>`
2. ✅ Клонирование при первом выборе - проверить что на ветке `develop`
3. ✅ Обновление при повторном выборе - проверить что pull выполнился
4. ✅ Подмодули обновляются автоматически
5. ✅ Подготовка релиза работает корректно

## См. также

- [SIMPLIFIED_RELEASE_PROCESS.md](SIMPLIFIED_RELEASE_PROCESS.md) - алгоритм подготовки релиза
- [CHANGELOG_SIMPLIFIED_BUILD.md](CHANGELOG_SIMPLIFIED_BUILD.md) - упрощение сборки
- [ADD_PROJECT_WIZARD.md](ADD_PROJECT_WIZARD.md) - документация мастера создания


